// Node types configuration
model NodeType {
    id                 String         @id
    name               String
    description        String // Basic flavor text
    extendedLore       String? // Optional boosted lore for engaging stories (e.g., AI-generated epics)
    baseYieldPerMinute Float
    maxMiners          Int
    lockInMinutes      Int // Dynamically generated based on rarity (e.g., Common: 6, Legendary: 144)
    rarity             NodeTypeRarity
    iconUrl            String?
    phase              Int? // Genesis phase (e.g., 1 for initial, null for non-phased-release)

    // Relations
    nodes   Node[]
    mastery UserNodeMastery[]

    @@index([rarity, phase]) // For efficient queries on rarity/phase
    @@map("node_types")
}

// Individual node instances
model Node {
    id            String  @id @default(cuid())
    name          String
    typeId        String
    latitude      Float
    longitude     Float
    openForMining Boolean @default(true)
    sponsor       String?
    lore          String
    phase         Int? // Mirrors NodeType phase for direct node filtering
    echoIntensity Float   @default(1.0)

    // Relations
    type           NodeType        @relation(fields: [typeId], references: [id])
    sessions       MiningSession[]
    locationLore   LocationLore? // New: One-to-one with location lore
    tuningSessions TuningSession[]
    drifts         NodeDrift[] // Relation to track drifts for this node

    @@index([phase]) // Efficient phase-based queries
    @@map("nodes")
}

// User node mastery
model UserNodeMastery {
    id        String   @id @default(cuid())
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    userId            String
    nodeTypeId        String
    level             Int    @default(0)
    sessionsCompleted Int    @default(0)
    bonusPercent      Float  @default(0.0)

    // Relations
    user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    nodeType NodeType @relation(fields: [nodeTypeId], references: [id], onDelete: Cascade)

    @@unique([userId, nodeTypeId], name: "user_node_mastery_unique")
    @@index([level], name: "mastery_level_idx")
    @@map("user_node_mastery")
}

// Enums
enum NodeTypeRarity {
    Common
    Uncommon
    Rare
    Epic
    Legendary
}
